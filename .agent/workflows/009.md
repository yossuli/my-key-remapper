---
description: データパス指向のプロップスフロー可視化とリファクタリング
---

# [Workflow-009] データパス指向のプロップスフロー可視化とリファクタリング

## 概要

開発が進むにつれてコンポーネントツリーが深くなると、意図しない Prop Drilling（バケツリレー）が発生し、コードの複雑度が増大します。
このワークフローでは、**「データの流れる経路（Data Path）」ごとにマトリクスを作成**して可視化し、不自然な依存関係を発見・解消する手順を定義します。

> [!IMPORTANT]
> 本プロジェクトでは **Context API は使用しません**。バケツリレーの解消は「Hooks への抽出」または「Prop Grouping」によって行います。

## 手順

### 1. データパスの特定

分析対象のツリーにおいて、データが流れる主要な経路を特定します。単なる「コンポーネント階層」で区切ると、中間で Drill (🚌) して行き先不明になるため、**最終的な消費先までを含む経路**を定義します。

例：

- **Control Path**: 親から制御用の子コンポーネントへ流れる（例：Toggle, Tabs）
- **Config Path**: 親から設定フォームの末端へ流れる（例：Input, Selector）

### 2. マトリクスの作成（可視化）

パスごとに表を作成します。各表には、そのパスに関与するコンポーネントのみを列として並べます。

- **ルール 1: Drill エンドの禁止**

  - 表の中間にあるコンポーネントが Drill (🚌) する場合、必ずその右側の列に最終的な Consumer (🔥) を配置します。
  - 「詳細は別表参照」として Drill で終わらせることを極力避けます。

- **ルール 2: 正式名称の使用**

  - ヘッダー（列名）は省略形ではなく、実際のコンポーネント名（例: `KeyEditorForm`）を使用します。

- **記号の定義**
  - **🆕 (Define)**: 生成
  - **🚌 (Drill)**: 自分は使わず子に渡すだけ（バケツリレー）
  - **🔥 (Use)**: 実際に使用
  - **🎁 (Pass Group)**: グループとしての運搬
  - **🔨 (Unpack)**: 分割代入
  - **🧩 (Individual)**: 個別渡し
  - **➖ (None)**: 関与なし

### 3. リファクタリング対象の発見

完成したマトリクスから、以下の改善サインを探します。

- **「🚌 (Drill)」の縦列**: 多くの階層を通過しているプロップスは、Hooks 化して末端が直接取得するようにするか、適切なグループに含めて運搬効率を上げます。
- **「🧩 (Individual)」の密集**: 関連するプロップスがバラバラに渡されている場所は、[Workflow-005](./005.md) に基づきグループ化します。

### 4. リファクタリングの実行

1.  **Hooks への抽出**: 状態管理ロジックをカスタムフックにまとめ、末端コンポーネントが直接 `useXxx()` を呼び出して自律化（Smart 化）します。
2.  **Prop Grouping の強化**: 親での一括制御が必要なデータは、適切な Group 型を定義して中間層を通過させます。
3.  **伝播の遮断**: 不要になったプロップスを中間層から削除し、マトリクスを「➖」で埋めていきます。

## チェックリスト

- [ ] 表は「データの経路」ごとに分割されているか？
- [ ] すべての 🚌 (Drill) は、同じ表内の右側で 🔥 (Use) に辿り着いているか？
- [ ] プロップス伝播を一通り書き出し、不要な Drill を特定したか？
- [ ] 中間コンポーネントでの不要な Props 定義が削除されたか？
- [ ] マトリクスを更新し、改善結果を視覚的に確認したか？


## 知見の種 (Seed) の記録

運用を通じて得られた「コーディングパターンの改善案」や「ルールの例外事例」は、`seeds.md` (Working Dir) へ記録してください（[Workflow-seed] 準拠）。

## 知見の継続的改善 (Continuous Knowledge Improvement)

このワークフローを使用する中で、新しい指示や改善点が見つかった場合は、必ずこのファイル (`.agent/workflows/009.md`) を更新・改善することを提案してください。
