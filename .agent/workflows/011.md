---
description: 回帰バグ（Regression）の調査と修正計画策定
---

# [Workflow-011] 回帰バグ（Regression）の調査と修正計画策定

## 概要

以前は動作していた機能が動作しなくなった（リグレッション）場合、単に機能を再実装するのではなく、「いつ」「なぜ」機能が削除または破損したのかを特定することが重要です。これにより、意図的な仕様変更との競合を防ぎ、再発防止策を講じることができます。

このワークフローでは、リグレッションの調査から実装計画への反映までの標準手順を定義します。

## 手順 (Step-by-Step)

### 1. 現状確認とキーワード特定

- **複数のキーワード候補を設定**:
  - 関数名や変数名だけでなく、UI に表示されるラベルテキスト（日本語/英語）、関連する定数名など、多角的にキーワードを準備してください。
  - コードベースにそのキーワードが**まだ残っているか**、それとも**完全に消えているか**を確認します。
- 例: `grep "SomeFunction"`, `grep "保存ボタン"`

### 2. 回帰ポイントの特定 (Git 調査)

機能が削除されている場合、以下の手順で削除されたタイミングを特定します。

#### 2-1. コミットメッセージからの絞り込み (推奨)

いきなりコード全文検索をする前に、コミットメッセージから「あたり」をつけます。

```powershell
git log --grep="refactor" --since="1 month ago" --oneline
```

- 怪しいコミット（リファクタリング、UI 刷新、大規模変更など）の日時やハッシュをメモします。

#### 2-2. Pickaxe 検索 (コード内容からの検索)

コミットメッセージで特定できない場合、Pickaxe 検索を行います。

- **Pickaxe 検索**: 特定の文字列が含まれる行が追加・削除されたコミットを検索します。

  ```powershell
  git log -S "DeletedFunctionName" --source --all
  ```

  ※ `--source --all` を付けることで、全ブランチ履歴から検索します。

- **原因コミットの特定**:
  検索結果から、該当機能が削除または変更されたコミットハッシュ（SHA）を特定します。

> [!WARNING]
> ヒットしたコミットの日付が**現在から極端に離れている場合（例: 1 年前）**、それは今回のリグレッションの原因ではない可能性が高いです。その場合は「ヒットしましたが日付が古すぎます」と私に報告し、別のキーワードやアプローチを検討してください。

> [!NOTE]
> 検索キーワードがリファクタリングで変更されていたり、プロパティ名が間違っていたりするとヒットしない可能性があります。単純な検索で見つからない場合は、より広範なキーワードや、関連する周辺ファイルの履歴から追跡することを検討してください。

### 3. 多角的な分析 (Diff 確認)

特定したコミットの内容を確認し、削除の意図を推測します。

- **Diff の確認**:
  ```powershell
  git show [COMMIT_HASH] [FILE_PATH]
  ```
- **確認事項**:
  - **リファクタリング**による誤削除か？（意図せず落ちてしまった）
  - **仕様変更**による意図的な削除か？（復活させるべきではない、または代替手段がある）
  - **大規模な書き換え**（Squash commit 等）に巻き込まれたか？
  - **人為的ミスの可能性**:
    - プロパティ名の指定ミス（似た名前のプロパティと取り違えていないか？）
    - 手動編集による単純な Typo や構文エラーがないか？
    - ※ ここで明示的に「編集ミス」や「プロパティ指定ミス」の可能性を疑うことで、確実な原因特定につなげます。

### 4. ユーザーへの確認・合意（重要）

推測や分析が完了したら、実装に移る前に必ずその推測が正しいかユーザーに確認を求めます。

- 「このコミットで、おそらく誤って削除されたようです」と報告し、復旧の方針（そのまま戻すか、新しい形にするか）について承認を得てください。

### 5. 実装計画への反映

実装計画 (`implementation_plan.md`) に「回帰詳細」セクションを追加し、調査結果を明記します。

- **必須項目**:
  - **以前の実装**: どう動いていたか
  - **問題のコミット**: ハッシュとコミットメッセージ
  - **削除されたコード**: `git show` の結果（抜粋）
  - **復旧方針**: 以前の実装をそのまま戻すか、現在のアーキテクチャに合わせて適応させるか

#### 記述例

```markdown
## 回帰（Regression）詳細

- **以前の実装**: `useKeyHoldAction` を使用して `VK.ENTER` を監視していた。
- **問題のコミット**: `cd15144` ("Active Keys UI のリファクタリング")
- **原因**: リファクタリング時の移動漏れ（誤削除）と推測される。
- **原因**: リファクタリング時の移動漏れ（誤削除）と推測される。
```

### 6. 知見化（Knowledge Creation）

今回の回帰バグが「普遍的なミス」や「構造的な問題」に起因する場合、単に直すだけでなく、将来のために知見化します。

- **ルール化の検討**:
  - 同じミスを防ぐための Linter ルールや型定義の改善が可能か？
  - ドキュメントやガイドラインへの追記が必要か？
- **Workflow-000 の実行**:
  - 汎用的な知見が得られた場合は、[Workflow-000] を使用して新しい Fix ルールを作成するか、`GEMINI.md` を更新してください。
  - 「個の気づき」を「チーム（プロジェクト）の知見」に昇華させます。

## チェックリスト

- [ ] 関連するキーワードで `git log -S` を実行したか？
- [ ] 回帰原因となるコミットハッシュを特定したか？
- [ ] コミットの内容（Diff）を確認し、削除の意図（誤削除 vs 仕様変更）を分析したか？
- [ ] 実装計画書に、コミットハッシュと削除されたコードの Diff を含めたか？
- [ ] 人為的ミス（プロパティ名、Typo 等）の可能性を検証したか？
- [ ] （必要な場合）得られた知見を Workflow-000 でルール化したか？

## 知見の継続的改善 (Continuous Knowledge Improvement)

このワークフローを使用する中で、新しい指示や改善点が見つかった場合は、必ずこのファイル (`.agent/workflows/011.md`) を更新・改善することを提案してください。
