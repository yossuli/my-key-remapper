---
description: データと設定の分離 (Data/Config Split)
---

# [Workflow-026] データと設定の分離 (Data/Config Split)

## 概要

アプリケーションの「挙動を制御する設定（Configuration）」と「ユーザーが作成したコンテンツデータ（User Data）」は、保存先ファイルおよび管理戦略を明確に分離するというアーキテクチャルールです。

## 背景・目的

- **設定 (Config)**: `version`, `windowSize`, `globalSettings` など。アプリ起動時に必須で、データ量は比較的小さい。
- **データ (Data)**: `macros`, `profiles`, `logs` など。ユーザーが作成・蓄積するもので、データ量が肥大化する可能性がある。

これらを `config.json` 1 つに混在させると、マクロが 100 個に増えただけで起動時の読み込みが遅くなったり、設定変更の保存時にマクロデータまで書き換えて破損させるリスクが発生します。

## ルール (Rules)

### 1. ファイルの分離

- **設定**: `config.json` (または `settings.json`)
- **データ**: `macros.json`, `history.json` 等、ドメインごとに独立したファイルにする。

### 2. 読み込み戦略 (Loading Strategy)

- **Config**: **Eager / Blocking**
  - アプリ起動直後（または初期化フェーズ）に同期的に、あるいは `await` で確実に読み込む。
  - これがないとアプリが正しく表示できないため。
- **Data**: **Lazy / Async**
  - 必要になったタイミング、またはバックグラウンドで非同期に読み込む。
  - データが存在しなくてもアプリ自体は起動できるようにする。

### 3. 保存戦略 (Saving Strategy)

- **部分的保存の徹底**:
  - 設定変更時は `config.json` のみ、マクロ編集時は `macros.json` のみを保存する。
  - メモリ上の巨大なオブジェクトをまるごと `JSON.stringify` して全ファイルを上書きする実装は**禁止**。

## 実装パターン (Example)

### Bad Implementation

```typescript
// 設定とマクロが混在
interface AppConfig {
  theme: string;
  macros: Macro[]; // 巨大になりうる
}

function saveConfig(config: AppConfig) {
  // テーマを変えただけなのに、マクロ配列も全て書き込みが発生する
  fs.writeFileSync("config.json", JSON.stringify(config));
}
```

### Good Implementation

```typescript
// 分離されたインターフェース
interface AppState {
  config: Config; // theme, etc.
  macros: Macro[];
}

// 独立した保存メソッド
class Storage {
  async saveConfig(config: Config) {
    await writeJson("config.json", config);
  }

  async saveMacros(macros: Macro[]) {
    await writeJson("macros.json", macros);
  }
}
```

## チェックリスト

- [ ] 設定値とユーザーデータが混ざっていないか？
- [ ] 巨大になりうる配列データは別ファイルに切り出されているか？
- [ ] 保存処理は更新対象のファイルのみを触っているか？

## 知見の種 (Seed) の記録

運用を通じて得られた「コーディングパターンの改善案」や「ルールの例外事例」は、`seeds.md` (Working Dir) へ記録してください（[Workflow-seed] 準拠）。
