---
description: 現在の変更差分(Diff)を分析し、リファクタリング計画を策定するワークフロー
---

1. **変更状況の把握**

   - `git status` を実行し、変更されたファイルを確認する。
   - `git diff` (ステージングされていない変更) および `git diff --cached` (ステージングされた変更) を実行し、具体的なコードの変更内容を取得する。

2. **変更の分析**

   - **包括的な分析（全変更対象）**:
     - AI 自身による変更か、ユーザーによる手動変更かに関わらず、**検出されたすべての変更を分析対象とする**。
     - ユーザーの手動変更が含まれる場合、その意図（バグ修正、重複排除、仕様変更など）をコードから推測し、リスペクトする。
   - 分析対象の変更について以下を行う:
     - 変更の意図を特定する（機能追加、バグ修正、リファクタリング、移動など）。
     - **UI 構造の可視化と検証 (Atomic Design)**:
       - UI コンポーネントに変更がある場合、影響範囲の呼び出し構造（Call Graph）を Mermaid で可視化する。
       - **同一ファイル内に複数のコンポーネントが定義されている場合も、それぞれを個別のノードとして定義する。**
         - ファイル境界を `subgraph "File: Title.tsx"` で囲み、物理的な配置と論理的な構造の関係を明確にする。
       - `subgraph` を使用して Atomic Design の階層（Atoms, Molecules, Organisms, Templates, Pages）を明確に表示する。
       - **検証**:
         - 上位層から下位層への依存（Organisms -> Atoms）が守られているか。
         - 下位層が上位層に依存していないか（Atoms -> Molecules などの逆流禁止）。
         - 横断的な依存（Organisms -> Organisms）が適切か（原則禁止、必要な場合は Templates で統合するなど）。
       - **修正案**:
         - 階層違反や不適切な依存がある場合、修正後の階層構造を示した Mermaid 図（To-Be）を作成し、計画に含める。
     - **ルール適合性の確認**:
       - `.agent/RULE.md` を参照し、各変更がプロジェクトのルールに準拠しているか厳密に確認する。
       - ルールに適合していない箇所が見つかった場合、それを修正するためのタスクを洗い出し、リファクタリング計画に追加する。
     - コードの品質（可読性、複雑度、重複、プロジェクト規約への準拠）を評価する。
     - 残存する課題（Lint エラー、TODO コメント、型定義の不足、不完全な実装など）を洗い出す。

3. **リファクタリング計画の策定**

   - 分析結果に基づき、必要なリファクタリングタスクをリストアップする。
   - プロジェクトのルール（`RULE.md`）や既存のアーキテクチャとの整合性を確認する。
   - `implementation_plan.md` を更新（または必要に応じて新規作成）し、具体的な手順を文書化する。
     - 既存の計画がある場合は、進捗を反映しつつ、新たな課題のためのセクションを追加する。
     - UI 構造検証の Mermaid 図も含める。

4. **ユーザーへの報告**
   - 作成した計画の概要をユーザーに通知し、承認を求める。
